<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARofGOT Management System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans Thai"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            900: '#312e81',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(99, 102, 241, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #F3F4F6; 
            color: #1E293B; 
            -webkit-font-smoothing: antialiased;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-fade-up { animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        input, select, textarea { transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { transform: translateY(-1px); }
        .timeline-track { min-width: 1200px; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helper Function: Format Date Standard ---
        // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö
        const formatThaiDate = (dateStr, withTime = false) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°

            const options = {
                year: 'numeric',
                month: 'short', // ‡∏°.‡∏Ñ., ‡∏Å.‡∏û.
                day: 'numeric',
                timeZone: 'Asia/Bangkok'
            };

            if (withTime) {
                options.hour = '2-digit';
                options.minute = '2-digit';
                options.second = '2-digit';
                options.hour12 = false; // 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
            }

            // toLocaleDateString('th-TH') ‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            return date.toLocaleDateString('th-TH', options);
        };

        const formatThaiMonth = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
        };


        // --- Components ---
        const LucideIcon = ({ name, size = 20, className = "" }) => {
            const iconMap = {
                'calendar': 'calendar_today', 'plus-circle': 'add_circle_outline', 'clock': 'schedule',
                'check-square': 'fact_check', 'bar-chart-3': 'bar_chart', 'car': 'directions_car',
                'log-out': 'logout', 'chevron-left': 'chevron_left', 'chevron-right': 'chevron_right',
                'edit-3': 'edit', 'check-circle': 'check_circle', 'user': 'person',
                'trash-2': 'delete_outline', 'mouse-pointer-2': 'ads_click', 'history': 'history',
                'info': 'info', 'map-pin': 'place', 'x': 'close'
            };
            return <span className={`material-icons-round ${className}`} style={{ fontSize: size }}>{iconMap[name] || name}</span>;
        };

        const TabBtn = ({ active, onClick, label, icon }) => (
            <button onClick={onClick} className={`px-5 py-2.5 rounded-full text-sm font-semibold transition-all flex items-center gap-2 whitespace-nowrap ${active ? 'bg-brand-600 text-white shadow-glow' : 'text-slate-500 hover:bg-white hover:text-slate-700'}`}>
                <LucideIcon name={icon} size={18} /> {label}
            </button>
        );

        const DataBox = ({ label, val, highlight, full }) => (
            <div className={`p-5 rounded-2xl border border-slate-100 ${full ? 'col-span-2 md:col-span-3' : ''} ${highlight ? 'bg-emerald-50 border-emerald-100' : 'bg-slate-50'}`}>
                <div className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-1">{label}</div>
                <div className={`font-bold text-xl leading-tight ${highlight ? 'text-emerald-600' : 'text-slate-800'}`}>{val}</div>
            </div>
        );

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA4m8o72tgcofx4_-L0n8_gsRIKWWPKJx4",
            authDomain: "carforrent-d4b1e.firebaseapp.com",
            projectId: "carforrent-d4b1e",
            storageBucket: "carforrent-d4b1e.firebasestorage.app",
            messagingSenderId: "684359505863",
            appId: "1:684359505863:web:6e252a61fe1786668e6be2"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'car-booking-system';

        const VEHICLES = [
            { id: 'v1', name: 'Isuzu Mu-X', plate: '3‡∏Ç‡∏å-4521 ‡∏Å‡∏ó‡∏°', type: 'SUV', image: 'üöô', engine: 'diesel' },
            { id: 'v2', name: 'Toyota Fortuner', plate: '2‡∏Ç‡∏à-3173 ‡∏Å‡∏ó‡∏°', type: 'SUV', image: 'üöô', engine: 'diesel' },
            { id: 'v3', name: 'Toyota Fortuner', plate: '2‡∏Ç‡∏à-3172 ‡∏Å‡∏ó‡∏°', type: 'SUV', image: 'üöô', engine: 'diesel' },
            { id: 'v4', name: 'Toyota Fortuner', plate: '2‡∏Ç‡∏à-3171 ‡∏Å‡∏ó‡∏°', type: 'SUV', image: 'üöô', engine: 'diesel' },
            { id: 'v5', name: 'MG4 EV', plate: '6‡∏Ç‡∏Ü-6240 ‡∏Å‡∏ó‡∏°', type: 'EV', image: '‚ö°', engine: 'electric' },
            { id: 'v6', name: 'MG4 EV', plate: '6‡∏Ç‡∏Ü-6230 ‡∏Å‡∏ó‡∏°', type: 'EV', image: '‚ö°', engine: 'electric' },
        ];

        // --- Main App ---
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [bookings, setBookings] = useState([]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('schedule');
            const [viewDate, setViewDate] = useState(new Date());
            
            // Report States
            const [reportSelectedMonth, setReportSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [chartVehicleId, setChartVehicleId] = useState(VEHICLES[0].id);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Booking & Form States
            const [selectedVehicle, setSelectedVehicle] = useState(null);
            const [formData, setFormData] = useState({ bookerName: '', department: '', startDate: '', endDate: '', destination: '', purpose: '' });
            const [adminPassword, setAdminPassword] = useState('');
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [returnModal, setReturnModal] = useState(null);
            const [scheduleModal, setScheduleModal] = useState(null); 
            const [returnData, setReturnData] = useState({ mileageStart: '', mileageEnd: '', fuelCost: '', note: '' });

            useEffect(() => {
                auth.signInAnonymously();
                const unsubBookings = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings')
                    .onSnapshot(snap => setBookings(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubLogs = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('logs')
                    .onSnapshot(snap => setLogs(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                setLoading(false);
                return () => { unsubBookings(); unsubLogs(); };
            }, []);

            // Chart Logic
            useEffect(() => {
                if (activeTab === 'report' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();

                    const monthsLabel = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                    const currentYear = new Date().getFullYear();
                    
                    const monthlyDist = monthsLabel.map((_, i) => {
                        return bookings.filter(b => b.vehicleId === chartVehicleId && b.status === 'completed' && new Date(b.startDate).getMonth() === i && new Date(b.startDate).getFullYear() === currentYear)
                                       .reduce((sum, b) => sum + (Number(b.mileageEnd) - Number(b.mileageStart)), 0);
                    });

                    const monthlyFuel = monthsLabel.map((_, i) => {
                        return bookings.filter(b => b.vehicleId === chartVehicleId && b.status === 'completed' && new Date(b.startDate).getMonth() === i && new Date(b.startDate).getFullYear() === currentYear)
                                       .reduce((sum, b) => sum + Number(b.fuelCost), 0);
                    });

                    Chart.defaults.font.family = "'Noto Sans Thai', 'Inter', sans-serif";
                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'line',
                        data: {
                            labels: monthsLabel,
                            datasets: [
                                { label: '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)', data: monthlyDist, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', borderWidth: 2, tension: 0.4, fill: true, yAxisID: 'y' },
                                { label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)', data: monthlyFuel, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 2, tension: 0.4, fill: true, yAxisID: 'y1' }
                            ]
                        },
                        options: {
                            responsive: true,
                            interaction: { mode: 'index', intersect: false },
                            plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } } },
                            scales: {
                                y: { type: 'linear', position: 'left', grid: { borderDash: [4, 4], color: '#f3f4f6' }, title: { display: true, text: '‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£' } },
                                y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: '‡∏ö‡∏≤‡∏ó' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
            }, [activeTab, chartVehicleId, bookings]);

            // --- Logic Functions ---

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° Log ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            const addLog = async (action, bookingData, extraInfo = '') => {
                const id = Date.now().toString();
                const vehicle = VEHICLES.find(v => v.id === bookingData.vehicleId);
                const carPlate = vehicle ? vehicle.plate : 'Unknown Car';
                
                // ‡πÉ‡∏ä‡πâ formatThaiDate ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log details
                const detailString = `${bookingData.bookerName} (${bookingData.department}) | ${carPlate} | ‡πÑ‡∏õ: ${bookingData.destination} | ${formatThaiDate(bookingData.startDate)} ‡∏ñ‡∏∂‡∏á ${formatThaiDate(bookingData.endDate)} ${extraInfo}`;

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('logs').doc(id).set({
                    id, 
                    action, 
                    details: detailString, 
                    user: currentUser?.name || 'Unknown', 
                    role: currentUser?.role || 'User', 
                    timestamp: new Date().toISOString()
                });
            };

            const checkAvailability = (vehicleId, start, end) => {
                const newStart = new Date(start).getTime();
                const newEnd = new Date(end).getTime();
                return !bookings.some(b => {
                    if (b.vehicleId !== vehicleId || b.status === 'rejected') return false;
                    const bStart = new Date(b.startDate).getTime();
                    const bEnd = new Date(b.endDate).getTime();
                    return (newStart <= bEnd && newEnd >= bStart);
                });
            };

            const handleBook = async (e) => {
                e.preventDefault();
                if (!checkAvailability(selectedVehicle.id, formData.startDate, formData.endDate)) {
                    alert("‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢: ‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß");
                    return;
                }
                const id = Date.now().toString();
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô ISO Format ‡πÉ‡∏ô Database ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏õ‡∏•‡∏á
                const newBooking = { ...formData, id, vehicleId: selectedVehicle.id, status: 'pending', timestamp: new Date().toISOString() };
                
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').doc(id).set(newBooking);
                
                // Log: ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà
                await addLog('‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà', newBooking);
                
                alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                setSelectedVehicle(null);
                setActiveTab('my-status');
            };

            const updateStatus = async (bId, status, extra = {}) => {
                const booking = bookings.find(x => x.id === bId);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').doc(bId).update({ status, ...extra });
                
                // Map status to Thai Action Name
                let actionName = status;
                if (status === 'approved') actionName = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
                else if (status === 'rejected') actionName = '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
                else if (status === 'pending_audit') actionName = '‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ';
                else if (status === 'completed') actionName = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ';

                let extraInfo = '';
                if (extra.mileageEnd) extraInfo = `[‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö: ${extra.mileageEnd}]`;

                await addLog(actionName, booking, extraInfo);
            };

            const handleDelete = async (bId) => {
                if (currentUser.role !== 'admin') {
                    alert("‚ö†Ô∏è ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
                    return;
                }
                if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                const booking = bookings.find(x => x.id === bId);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').doc(bId).delete();
                
                // Log: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                await addLog('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', booking);
            };

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-brand-600 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>;

            // --- Login Screen ---
            if (!currentUser) {
                return (
                    <div className="h-screen flex items-center justify-center p-6 bg-slate-100 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-brand-100/50 to-transparent pointer-events-none"></div>
                        <div className="bg-white p-10 rounded-[2rem] shadow-xl w-full max-w-sm text-center relative z-10 animate-fade-up">
                            <div className="w-16 h-16 bg-brand-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-brand-500/30 text-white">
                                <LucideIcon name="car" size={32} />
                            </div>
                            <h1 className="text-3xl font-black text-slate-800 mb-2">CARofGOT</h1>
                            <p className="text-slate-400 text-sm mb-8">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</p>
                            
                            {!showAdminLogin ? (
                                <div className="space-y-3">
                                    <button onClick={() => setCurrentUser({role:'user', name:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'})} className="w-full py-3.5 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 hover:shadow-lg hover:shadow-brand-500/20 transition-all active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
                                    <button onClick={() => setShowAdminLogin(true)} className="text-slate-400 text-xs font-bold uppercase tracking-widest hover:text-brand-600 transition-colors py-2 block w-full">Admin Login</button>
                                </div>
                            ) : (
                                <form onSubmit={(e)=>{e.preventDefault(); if(adminPassword==='123456') setCurrentUser({role:'admin', name:'‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'})}} className="space-y-4">
                                    <input type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" className="w-full p-4 border border-slate-200 bg-slate-50 rounded-xl text-center font-bold outline-none focus:bg-white focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all" autoFocus onChange={e=>setAdminPassword(e.target.value)} />
                                    <button className="w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                    <button type="button" onClick={()=>setShowAdminLogin(false)} className="text-slate-400 text-xs py-2 block w-full hover:text-slate-600">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                                </form>
                            )}
                        </div>
                    </div>
                );
            }

            // --- Dashboard ---
            return (
                <div className="min-h-screen pb-20 font-sans">
                    {/* Navbar */}
                    <nav className="glass sticky top-0 z-50 px-4 md:px-6 py-4 border-b border-slate-200/60">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-brand-600 p-2 rounded-lg text-white shadow-md shadow-brand-500/20"><LucideIcon name="car" size={20}/></div>
                                <div className="leading-none">
                                    <div className="font-black text-lg text-slate-800 tracking-tight">CARofGOT</div>
                                    <div className="text-[10px] text-brand-600 font-bold uppercase tracking-widest">GOT System</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="text-right hidden sm:block">
                                    <div className="text-sm font-bold text-slate-700">{currentUser.name}</div>
                                    <div className="text-[10px] text-slate-400 font-bold uppercase">{currentUser.role}</div>
                                </div>
                                <button onClick={() => setCurrentUser(null)} className="p-2 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-colors"><LucideIcon name="log-out" size={20}/></button>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
                        
                        {/* Tab Navigation */}
                        <div className="flex justify-center md:justify-start">
                            <div className="flex gap-2 bg-white p-2 rounded-full shadow-soft w-fit max-w-full overflow-x-auto scrollbar-hide">
                                <TabBtn active={activeTab==='schedule'} onClick={()=>setActiveTab('schedule')} label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ" icon="calendar" />
                                {currentUser.role === 'user' && <TabBtn active={activeTab==='booking'} onClick={()=>setActiveTab('booking')} label="‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà" icon="plus-circle" />}
                                <TabBtn active={activeTab==='my-status'} onClick={()=>setActiveTab('my-status')} label={currentUser.role==='admin' ? '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á' : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'} icon="clock" />
                                {currentUser.role === 'admin' && (
                                    <>
                                        <TabBtn active={activeTab==='audit'} onClick={()=>setActiveTab('audit')} label="‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ" icon="check-square" />
                                        <TabBtn active={activeTab==='report'} onClick={()=>setActiveTab('report')} label="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" icon="bar-chart-3" />
                                        <TabBtn active={activeTab==='logs'} onClick={()=>setActiveTab('logs')} label="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" icon="history" />
                                    </>
                                )}
                            </div>
                        </div>

                        {/* Content Area */}
                        
                        {/* 1. SCHEDULE TAB */}
                        {activeTab === 'schedule' && (
                            <div className="bg-white rounded-3xl shadow-soft overflow-hidden border border-slate-100 animate-fade-up">
                                <div className="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                                    <h2 className="font-bold text-lg text-slate-800">üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                                    <div className="flex items-center gap-2 bg-slate-50 p-1 rounded-xl">
                                        <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()-1))} className="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all text-slate-500"><LucideIcon name="chevron-left" size={18}/></button>
                                        <span className="text-sm font-bold text-slate-700 px-3 min-w-[120px] text-center">
                                            {/* ‡πÉ‡∏ä‡πâ Locale TH ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ ‡∏û.‡∏®. */}
                                            {viewDate.toLocaleDateString('th-TH', {month:'long', year:'numeric'})}
                                        </span>
                                        <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()+1))} className="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all text-slate-500"><LucideIcon name="chevron-right" size={18}/></button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <div className="timeline-track p-4">
                                        {/* Date Header */}
                                        <div className="grid grid-cols-[220px_1fr] mb-4">
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider pt-4 pl-4">Vehicle info</div>
                                            <div className="grid" style={{gridTemplateColumns: `repeat(${getDaysInMonth(viewDate)}, 1fr)`}}>
                                                {Array.from({length: getDaysInMonth(viewDate)}).map((_,i)=>(
                                                    <div key={i} className="text-center text-[10px] font-bold text-slate-400 border-l border-slate-100 pb-2">{i+1}</div>
                                                ))}
                                            </div>
                                        </div>
                                        {/* Rows */}
                                        {VEHICLES.map(v => (
                                            <div key={v.id} className="grid grid-cols-[220px_1fr] mb-3 group hover:bg-slate-50/50 rounded-xl transition-colors">
                                                <div className="p-3 flex items-center gap-4 bg-white rounded-l-xl border-y border-l border-slate-100 z-10 relative shadow-sm group-hover:shadow-md transition-all">
                                                    <div className="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-xl">{v.image}</div>
                                                    <div>
                                                        <div className="font-bold text-slate-700 text-sm">{v.plate}</div>
                                                        <div className="text-[10px] text-slate-400 font-medium uppercase tracking-wide">{v.name}</div>
                                                    </div>
                                                </div>
                                                <div className="relative grid bg-slate-50/30 rounded-r-xl border-y border-r border-slate-100" style={{gridTemplateColumns: `repeat(${getDaysInMonth(viewDate)}, 1fr)`}}>
                                                    {Array.from({length: getDaysInMonth(viewDate)}).map((_,i)=><div key={i} className="border-l border-slate-100 h-full"></div>)}
                                                    {bookings.filter(b=>b.vehicleId===v.id && ['approved','pending','pending_audit','completed'].includes(b.status)).map(b=>{
                                                        const start = new Date(b.startDate);
                                                        if (start.getMonth() !== viewDate.getMonth()) return null;
                                                        const sD = start.getDate(); 
                                                        const end = new Date(b.endDate);
                                                        const eD = end.getMonth() === viewDate.getMonth() ? end.getDate() : getDaysInMonth(viewDate);
                                                        const days = eD - sD + 1;
                                                        const isPending = b.status === 'pending';
                                                        return (
                                                            <div key={b.id} onClick={() => setScheduleModal(b)} className={`absolute top-2 bottom-2 mx-[1px] rounded-lg text-white text-[10px] font-bold flex items-center px-3 shadow-sm z-10 transition-all hover:scale-105 hover:z-20 cursor-pointer ${isPending ? 'bg-rose-500/90' : 'bg-brand-500/90'}`}
                                                                 style={{ left: `calc(${(sD-1)*(100/getDaysInMonth(viewDate))}% )`, width: `calc(${days*(100/getDaysInMonth(viewDate))}% )` }}>
                                                                <span className="truncate w-full">{b.bookerName}</span>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="px-6 py-3 bg-slate-50 border-t border-slate-100 flex gap-6 text-xs font-bold text-slate-500">
                                    <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-rose-500"></div> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                                    <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-brand-500"></div> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</div>
                                </div>
                            </div>
                        )}

                        {/* 2. BOOKING TAB */}
                        {activeTab === 'booking' && (
                            <div className="grid lg:grid-cols-2 gap-8 animate-fade-up">
                                <div className="space-y-6">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold text-sm">1</div>
                                        <h2 className="font-bold text-xl text-slate-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h2>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {VEHICLES.map(v => (
                                            <div key={v.id} onClick={()=>setSelectedVehicle(v)} className={`relative p-5 rounded-3xl border-2 cursor-pointer transition-all hover:shadow-lg ${selectedVehicle?.id===v.id ? 'border-brand-500 bg-brand-50/50' : 'bg-white border-transparent hover:border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-4">
                                                    <div className="text-4xl bg-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-sm">{v.image}</div>
                                                    {selectedVehicle?.id===v.id && <div className="text-brand-600 bg-white rounded-full p-1"><LucideIcon name="check-circle" /></div>}
                                                </div>
                                                <div className="font-bold text-lg text-slate-800">{v.plate}</div>
                                                <div className="text-xs text-slate-500 font-medium uppercase tracking-wide">{v.name} ‚Ä¢ {v.type}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="relative">
                                    {selectedVehicle ? (
                                        <form onSubmit={handleBook} className="bg-white p-8 rounded-3xl shadow-soft border border-slate-100 space-y-6 sticky top-28">
                                            <div className="flex items-center gap-3 pb-6 border-b border-slate-100">
                                                <div className="w-8 h-8 rounded-full bg-brand-600 text-white flex items-center justify-center font-bold text-sm">2</div>
                                                <h3 className="font-bold text-xl text-slate-800">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="space-y-2">
                                                    <label className="text-xs font-bold text-slate-500 ml-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
                                                    <input type="date" required className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10" onChange={e=>setFormData({...formData, startDate:e.target.value})} />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className="text-xs font-bold text-slate-500 ml-1">‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö</label>
                                                    <input type="date" required className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10" onChange={e=>setFormData({...formData, endDate:e.target.value})} />
                                                </div>
                                            </div>

                                            <div className="space-y-4">
                                                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ì‡∏±‡∏ê‡∏û‡∏•)" required className="w-full p-4 bg-slate-50 border-0 rounded-xl text-sm font-semibold outline-none focus:ring-2 focus:ring-brand-500/20" onChange={e=>setFormData({...formData, bookerName:e.target.value})} />
                                                <input type="text" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏à‡∏Ñ.)" required className="w-full p-4 bg-slate-50 border-0 rounded-xl text-sm font-semibold outline-none focus:ring-2 focus:ring-brand-500/20" onChange={e=>setFormData({...formData, department:e.target.value})} />
                                                <input type="text" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏ü‡∏ô.1)" required className="w-full p-4 bg-slate-50 border-0 rounded-xl text-sm font-semibold outline-none focus:ring-2 focus:ring-brand-500/20" onChange={e=>setFormData({...formData, destination:e.target.value})} />
                                                <textarea placeholder="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á..." required className="w-full p-4 bg-slate-50 border-0 rounded-xl text-sm font-semibold outline-none focus:ring-2 focus:ring-brand-500/20 resize-none" rows="3" onChange={e=>setFormData({...formData, purpose:e.target.value})}></textarea>
                                            </div>

                                            <button className="w-full py-4 bg-brand-600 text-white rounded-2xl font-bold shadow-lg shadow-brand-500/30 hover:bg-brand-700 hover:shadow-brand-500/50 hover:-translate-y-0.5 transition-all">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏£‡∏ñ</button>
                                        </form>
                                    ) : (
                                        <div className="h-full min-h-[400px] flex flex-col items-center justify-center p-12 border-2 border-dashed border-slate-200 rounded-3xl text-slate-300 bg-slate-50/50">
                                            <LucideIcon name="mouse-pointer-2" size={64} className="mb-4 opacity-50" />
                                            <p className="font-bold text-sm uppercase tracking-widest">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 3. MY STATUS TAB */}
                        {activeTab === 'my-status' && (
                            <div className="grid gap-4 animate-fade-up">
                                {bookings.length === 0 ? 
                                    <div className="text-center py-32 text-slate-400 font-medium bg-white rounded-3xl border border-dashed border-slate-200">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div> :
                                    bookings.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(b => (
                                        <div key={b.id} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-soft hover:shadow-md transition-all flex flex-col md:flex-row items-center gap-6 group">
                                            <div className="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center text-4xl shadow-inner">{VEHICLES.find(v=>v.id===b.vehicleId)?.image}</div>
                                            <div className="flex-1 w-full text-center md:text-left">
                                                <div className="flex flex-col md:flex-row md:items-center gap-3 mb-2">
                                                    <span className="font-bold text-lg text-slate-800">{b.destination}</span>
                                                    <span className={`w-fit mx-auto md:mx-0 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${
                                                        b.status === 'approved' ? 'bg-emerald-100 text-emerald-600' :
                                                        b.status === 'pending' ? 'bg-amber-100 text-amber-600' :
                                                        b.status === 'completed' ? 'bg-slate-100 text-slate-500' : 'bg-rose-100 text-rose-600'
                                                    }`}>{b.status}</span>
                                                </div>
                                                <div className="text-xs font-medium text-slate-500 flex flex-wrap justify-center md:justify-start gap-4">
                                                    <span className="flex items-center gap-1"><LucideIcon name="user" size={14}/> {b.bookerName} ({b.department}) - {VEHICLES.find(v=>v.id===b.vehicleId)?.plate}</span>
                                                    {/* ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ */}
                                                    <span className="flex items-center gap-1"><LucideIcon name="calendar" size={14}/> {formatThaiDate(b.startDate)} ‡∏ñ‡∏∂‡∏á {formatThaiDate(b.endDate)}</span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                {currentUser.role === 'admin' && b.status === 'pending' && (
                                                    <>
                                                        <button onClick={()=>updateStatus(b.id, 'approved')} className="px-5 py-2.5 bg-brand-600 text-white rounded-xl font-bold text-xs shadow-lg shadow-brand-500/20 hover:bg-brand-700 hover:-translate-y-0.5 transition-all">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                                        <button onClick={()=>updateStatus(b.id, 'rejected')} className="px-5 py-2.5 bg-rose-50 text-rose-500 rounded-xl font-bold text-xs hover:bg-rose-100 transition-all">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                                    </>
                                                )}
                                                {b.status === 'approved' && (
                                                    <button onClick={()=>{setReturnModal(b); setReturnData({mileageStart:'10000', mileageEnd:'', fuelCost:'', note:''})}} className="px-5 py-2.5 bg-emerald-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-emerald-500/20 hover:bg-emerald-600 hover:-translate-y-0.5 transition-all animate-pulse">‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</button>
                                                )}
                                                {currentUser.role === 'admin' && (
                                                    <button onClick={()=>handleDelete(b.id)} className="p-3 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-xl transition-all">
                                                        <LucideIcon name="trash-2" size={18}/>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                }
                            </div>
                        )}

                        {/* 4. REPORT TAB (Admin) */}
                        {activeTab === 'report' && (
                            <div className="space-y-8 animate-fade-up">
                                <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                                    <div>
                                        <h2 className="font-black text-2xl text-slate-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h2>
                                        <p className="text-slate-500 text-sm mt-1">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                                    </div>
                                    <div className="flex items-center gap-3 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                                        <span className="text-xs font-bold text-slate-400 uppercase px-3">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
                                        {/* ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ input type="month" ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏° OS User */}
                                        <div className="flex items-center bg-slate-100 rounded-xl px-2">
                                            <input type="month" value={reportSelectedMonth} onChange={e=>setReportSelectedMonth(e.target.value)} className="bg-transparent py-2 text-sm font-bold text-slate-700 outline-none border-transparent w-32" />
                                            <span className="text-xs text-brand-600 font-bold pr-2 whitespace-nowrap">{formatThaiMonth(reportSelectedMonth)}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Table */}
                                <div className="bg-white rounded-3xl border border-slate-200 shadow-soft overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left whitespace-nowrap">
                                            <thead>
                                                <tr className="bg-slate-50/80 border-b border-slate-100 text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                    <th className="p-6">‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</th>
                                                    <th className="p-6 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
                                                    <th className="p-6 text-center">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                                                    <th className="p-6 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-sm font-medium text-slate-600 divide-y divide-slate-100">
                                                {VEHICLES.map(v => {
                                                    const filtered = bookings.filter(b => b.vehicleId === v.id && b.status === 'completed' && b.startDate.startsWith(reportSelectedMonth));
                                                    const totalKm = filtered.reduce((s, b) => s + (Number(b.mileageEnd) - Number(b.mileageStart)), 0);
                                                    const totalFuel = filtered.reduce((s, b) => s + Number(b.fuelCost), 0);
                                                    return (
                                                        <tr key={v.id} className="hover:bg-slate-50/50 transition-colors">
                                                            <td className="p-6">
                                                                <div className="flex items-center gap-4">
                                                                    <div className="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-xl">{v.image}</div>
                                                                    <div>
                                                                        <div className="font-bold text-slate-800">{v.plate}</div>
                                                                        <div className="text-[10px] text-slate-400 uppercase font-bold">{v.name}</div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="p-6 text-center text-base">{totalKm.toLocaleString()}</td>
                                                            <td className="p-6 text-center text-base font-bold text-emerald-600">{totalFuel.toLocaleString()} ‡∏ø</td>
                                                            <td className="p-6 text-center"><span className="px-3 py-1 rounded-full bg-slate-100 text-xs font-bold">{filtered.length}</span></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Graph */}
                                <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-soft space-y-6">
                                    <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                        <div>
                                            <h3 className="font-bold text-lg text-slate-800">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                                            <p className="text-xs text-slate-400 mt-1">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</p>
                                        </div>
                                        <select value={chartVehicleId} onChange={e=>setChartVehicleId(e.target.value)} className="p-2.5 pl-4 pr-10 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-brand-500/20">
                                            {VEHICLES.map(v => <option key={v.id} value={v.id}>{v.plate} ({v.name})</option>)}
                                        </select>
                                    </div>
                                    <div className="relative h-[350px] w-full">
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 5. AUDIT TAB (Admin) */}
                        {activeTab === 'audit' && (
                            <div className="space-y-4 animate-fade-up">
                                {bookings.filter(b=>b.status==='pending_audit').length === 0 ? 
                                    <div className="text-center py-20 text-slate-400 bg-white rounded-3xl border border-dashed">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</div> :
                                    bookings.filter(b=>b.status==='pending_audit').map(b => (
                                    <div key={b.id} className="bg-white p-8 rounded-3xl shadow-soft border border-slate-100 flex flex-col lg:flex-row gap-8 items-center">
                                        <div className="flex items-center gap-6 lg:w-1/3">
                                            <div className="text-5xl w-24 h-24 bg-slate-50 rounded-2xl flex items-center justify-center">{VEHICLES.find(v=>v.id===b.vehicleId)?.image}</div>
                                            <div>
                                                <div className="font-black text-2xl text-slate-800 mb-1">{VEHICLES.find(v=>v.id===b.vehicleId)?.plate}</div>
                                                <div className="text-sm font-bold text-slate-500">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {b.bookerName}</div>
                                            </div>
                                        </div>
                                        <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4 w-full">
                                            <DataBox label="‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°" val={b.mileageStart} />
                                            <DataBox label="‡πÑ‡∏°‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ" val={b.mileageEnd} highlight />
                                            <DataBox label="‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á" val={`${Number(b.mileageEnd) - Number(b.mileageStart)} ‡∏Å‡∏°.`} />
                                            <DataBox label="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" val={`${b.fuelCost} ‡∏ø`} highlight />
                                        </div>
                                        <div className="w-full lg:w-auto">
                                            <button onClick={()=>updateStatus(b.id, 'completed')} className="w-full px-8 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-lg hover:bg-black hover:shadow-xl hover:-translate-y-1 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 6. LOGS TAB (Admin) */}
                        {activeTab === 'logs' && (
                            <div className="bg-white rounded-3xl border border-slate-200 shadow-soft overflow-hidden animate-fade-up">
                                <div className="p-6 border-b border-slate-100 bg-slate-50/50">
                                    <h3 className="font-bold text-lg text-slate-800">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left whitespace-nowrap">
                                        <thead>
                                            <tr className="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                                <th className="p-5 pl-8">Time</th>
                                                <th className="p-5">Action</th>
                                                <th className="p-5">Details</th>
                                                <th className="p-5">User</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm divide-y divide-slate-50">
                                            {logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 50).map(log => (
                                                <tr key={log.id} className="hover:bg-slate-50/50 transition-colors">
                                                    {/* ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ß‡∏•‡∏≤ */}
                                                    <td className="p-5 pl-8 text-slate-400 font-mono text-xs">{formatThaiDate(log.timestamp, true)}</td>
                                                    <td className="p-5">
                                                        <span className={`px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide border ${
                                                            log.action === '‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà' ? 'bg-indigo-50 text-indigo-700 border-indigo-100' :
                                                            log.action === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á' || log.action === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' :
                                                            log.action === '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' ? 'bg-rose-50 text-rose-700 border-rose-100' :
                                                            'bg-slate-50 text-slate-700 border-slate-100'
                                                        }`}>
                                                            {log.action}
                                                        </span>
                                                    </td>
                                                    <td className="p-5 text-slate-700 font-medium text-xs">{log.details}</td>
                                                    <td className="p-5">
                                                        <div className="font-bold text-slate-800 text-xs">{log.user}</div>
                                                        <div className="text-[10px] text-slate-400 uppercase">{log.role}</div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                    </div>

                    {/* Return Modal */}
                    {returnModal && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-md shadow-2xl animate-fade-up overflow-hidden">
                                <div className="bg-emerald-500 p-8 text-white relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-4 opacity-10"><LucideIcon name="check-circle" size={100} /></div>
                                    <h3 className="text-2xl font-black relative z-10">‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</h3>
                                    <p className="text-emerald-100 text-xs font-bold uppercase tracking-widest mt-1 relative z-10">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
                                </div>
                                <div className="p-8 space-y-5">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">‡πÑ‡∏°‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ</label>
                                            <input type="number" required className="w-full p-4 bg-slate-50 rounded-2xl font-bold text-slate-700 outline-none border border-slate-100" value={returnData.mileageStart} onChange={e=>setReturnData({...returnData, mileageStart:e.target.value})} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">‡πÑ‡∏°‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ</label>
                                            <input type="number" required className="w-full p-4 bg-white border-2 border-emerald-100 rounded-2xl font-bold text-emerald-600 outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all" value={returnData.mileageEnd} autoFocus onChange={e=>setReturnData({...returnData, mileageEnd:e.target.value})} />
                                        </div>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô / ‡∏Ñ‡πà‡∏≤‡∏ä‡∏≤‡∏£‡πå‡∏à (‡∏ö‡∏≤‡∏ó)</label>
                                        <input type="number" required placeholder="0.00" className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-slate-800 outline-none focus:border-slate-300" onChange={e=>setReturnData({...returnData, fuelCost:e.target.value})} />
                                    </div>
                                    <textarea placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..." className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-medium outline-none focus:border-slate-300 resize-none" rows="2" onChange={e=>setReturnData({...returnData, note:e.target.value})}></textarea>
                                    
                                    <div className="flex gap-3 pt-2">
                                        <button onClick={()=>setReturnModal(null)} className="flex-1 py-4 font-bold text-slate-400 hover:text-slate-600 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        <button onClick={()=>{updateStatus(returnModal.id, 'pending_audit', returnData); setReturnModal(null);}} className="flex-[2] py-4 bg-emerald-500 text-white rounded-2xl font-bold shadow-lg shadow-emerald-500/30 hover:bg-emerald-600 hover:-translate-y-0.5 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Schedule Info Modal (Popup ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á) */}
                    {scheduleModal && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-sm shadow-2xl animate-fade-up overflow-hidden border border-white">
                                <div className="bg-brand-600 p-6 text-white relative">
                                    <div className="absolute top-4 right-4 cursor-pointer opacity-70 hover:opacity-100 transition-opacity" onClick={() => setScheduleModal(null)}>
                                        <LucideIcon name="x" size={24} />
                                    </div>
                                    <div className="text-[10px] font-bold uppercase tracking-widest opacity-80 mb-1">Booking Details</div>
                                    <h3 className="text-xl font-black">{scheduleModal.destination}</h3>
                                    {/* ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ */}
                                    <div className="flex items-center gap-2 mt-2 text-sm font-medium opacity-90">
                                        <LucideIcon name="calendar" size={16} />
                                        {formatThaiDate(scheduleModal.startDate)} - {formatThaiDate(scheduleModal.endDate)}
                                    </div>
                                </div>
                                <div className="p-6 space-y-4 text-sm text-slate-600">
                                    <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                                        <div className="bg-white p-2 rounded-lg shadow-sm text-brand-600"><LucideIcon name="user" /></div>
                                        <div>
                                            <div className="font-bold text-slate-800">{scheduleModal.bookerName}</div>
                                            <div className="text-xs text-slate-400">‡πÅ‡∏ú‡∏ô‡∏Å: {scheduleModal.department}</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                                        <div className="bg-white p-2 rounded-lg shadow-sm text-brand-600"><LucideIcon name="car" /></div>
                                        <div>
                                            <div className="font-bold text-slate-800">{VEHICLES.find(v=>v.id===scheduleModal.vehicleId)?.plate}</div>
                                            <div className="text-xs text-slate-400">{VEHICLES.find(v=>v.id===scheduleModal.vehicleId)?.name}</div>
                                        </div>
                                    </div>
                                    <div className="p-3 bg-slate-50 rounded-xl">
                                        <div className="text-[10px] font-bold text-slate-400 uppercase mb-1">Purpose</div>
                                        <div className="font-medium text-slate-800">{scheduleModal.purpose}</div>
                                    </div>
                                    <div className="pt-2">
                                        <div className={`text-center py-2 rounded-lg text-xs font-bold uppercase ${
                                            scheduleModal.status === 'approved' ? 'bg-emerald-100 text-emerald-600' :
                                            scheduleModal.status === 'pending' ? 'bg-amber-100 text-amber-600' :
                                            scheduleModal.status === 'completed' ? 'bg-slate-100 text-slate-500' : 'bg-rose-100 text-rose-600'
                                        }`}>
                                            Status: {scheduleModal.status}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
