<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARofGOT Management System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #334155; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-shadow { box-shadow: 0 4px 15px -3px rgba(79, 70, 229, 0.1); }
        .material-icons-round { vertical-align: middle; }
        .timeline-track { min-width: 1200px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const LucideIcon = ({ name, size = 20, className = "" }) => {
            const iconMap = {
                'calendar': 'calendar_today', 'plus-circle': 'add_circle_outline', 'clock': 'schedule',
                'check-square': 'fact_check', 'bar-chart-3': 'bar_chart', 'car': 'directions_car',
                'log-out': 'logout', 'chevron-left': 'chevron_left', 'chevron-right': 'chevron_right',
                'edit-3': 'edit', 'check-circle': 'check_circle', 'user': 'person',
                'trash-2': 'delete_outline', 'mouse-pointer-2': 'ads_click', 'history': 'history'
            };
            const materialName = iconMap[name] || name;
            return (
                <span className={`material-icons-round ${className}`} style={{ fontSize: size, width: size, height: size, overflow: 'hidden', display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}>
                    {materialName}
                </span>
            );
        };

        const firebaseConfig = {
            apiKey: "AIzaSyA4m8o72tgcofx4_-L0n8_gsRIKWWPKJx4",
            authDomain: "carforrent-d4b1e.firebaseapp.com",
            projectId: "carforrent-d4b1e",
            storageBucket: "carforrent-d4b1e.firebasestorage.app",
            messagingSenderId: "684359505863",
            appId: "1:684359505863:web:6e252a61fe1786668e6be2"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'car-booking-system';

        const VEHICLES = [
            { id: 'v1', name: 'Isuzu Mu-X', plate: '3‡∏Ç‡∏å-4521 ‡∏Å‡∏ó‡∏°', type: 'SUV', image: 'üöô', engine: 'diesel' },
            { id: 'v2', name: 'Toyota Fortuner', plate: '2‡∏Ç‡∏à-3173 ‡∏Å‡∏ó‡∏°', type: 'SUV', image: 'üöô', engine: 'diesel' },
            { id: 'v3', name: 'Toyota Fortuner', plate: '2‡∏Ç‡∏à-3172 ‡∏Å‡∏ó‡∏°', type: 'SUV', image: 'üöô', engine: 'diesel' },
            { id: 'v4', name: 'Toyota Fortuner', plate: '2‡∏Ç‡∏à-3171 ‡∏Å‡∏ó‡∏°', type: 'SUV', image: 'üöô', engine: 'diesel' },
            { id: 'v5', name: 'MG4 EV', plate: '6‡∏Ç‡∏Ü-6240 ‡∏Å‡∏ó‡∏°', type: 'EV', image: '‚ö°', engine: 'electric' },
            { id: 'v6', name: 'MG4 EV', plate: '6‡∏Ç‡∏Ü-6230 ‡∏Å‡∏ó‡∏°', type: 'EV', image: '‚ö°', engine: 'electric' },
        ];

        const TabBtn = ({ active, onClick, label, icon }) => (
            <button onClick={onClick} className={`px-5 py-2.5 rounded-xl text-xs font-black transition-all flex items-center gap-2 whitespace-nowrap ${active ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>
                <LucideIcon name={icon} size={16} /> {label}
            </button>
        );

        const DataBox = ({ label, val, highlight, full }) => (
            <div className={`bg-slate-50 p-4 rounded-2xl ${full ? 'col-span-2 md:col-span-3' : ''} ${highlight ? 'ring-2 ring-emerald-100 bg-emerald-50/50' : ''}`}>
                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{label}</div>
                <div className={`font-black text-lg leading-tight ${highlight ? 'text-emerald-600' : 'text-slate-800'}`}>{val}</div>
            </div>
        );

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [bookings, setBookings] = useState([]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('schedule');
            const [viewDate, setViewDate] = useState(new Date());
            
            // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Report
            const [reportSelectedMonth, setReportSelectedMonth] = useState(new Date().toISOString().slice(0, 7)); // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM
            const [chartVehicleId, setChartVehicleId] = useState(VEHICLES[0].id);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const [selectedVehicle, setSelectedVehicle] = useState(null);
            const [formData, setFormData] = useState({ bookerName: '', department: '', startDate: '', endDate: '', destination: '', purpose: '' });
            const [adminPassword, setAdminPassword] = useState('');
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [returnModal, setReturnModal] = useState(null);
            const [returnData, setReturnData] = useState({ mileageStart: '', mileageEnd: '', fuelCost: '', note: '' });

            useEffect(() => {
                auth.signInAnonymously();
                const unsubBookings = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings')
                    .onSnapshot(snap => setBookings(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubLogs = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('logs')
                    .onSnapshot(snap => setLogs(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                setLoading(false);
                return () => { unsubBookings(); unsubLogs(); };
            }, []);

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏°‡∏∑‡πà‡∏≠ Tab Report ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            useEffect(() => {
                if (activeTab === 'report' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();

                    const monthsLabel = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                    const currentYear = new Date().getFullYear();
                    
                    const monthlyDist = monthsLabel.map((_, i) => {
                        return bookings.filter(b => b.vehicleId === chartVehicleId && b.status === 'completed' && new Date(b.startDate).getMonth() === i && new Date(b.startDate).getFullYear() === currentYear)
                                       .reduce((sum, b) => sum + (Number(b.mileageEnd) - Number(b.mileageStart)), 0);
                    });

                    const monthlyFuel = monthsLabel.map((_, i) => {
                        return bookings.filter(b => b.vehicleId === chartVehicleId && b.status === 'completed' && new Date(b.startDate).getMonth() === i && new Date(b.startDate).getFullYear() === currentYear)
                                       .reduce((sum, b) => sum + Number(b.fuelCost), 0);
                    });

                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'line',
                        data: {
                            labels: monthsLabel,
                            datasets: [
                                { label: '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (‡∏Å‡∏°.)', data: monthlyDist, borderColor: '#6366f1', backgroundColor: '#6366f1', tension: 0.3, yAxisID: 'y' },
                                { label: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Ñ‡πà‡∏≤‡∏ä‡∏≤‡∏£‡πå‡∏à (‡∏ö‡∏≤‡∏ó)', data: monthlyFuel, borderColor: '#10b981', backgroundColor: '#10b981', tension: 0.3, yAxisID: 'y1' }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { position: 'top', labels: { font: { weight: 'bold' } } } },
                            scales: {
                                y: { type: 'linear', position: 'left', title: { display: true, text: '‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£' } },
                                y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: '‡∏ö‡∏≤‡∏ó' } }
                            }
                        }
                    });
                }
            }, [activeTab, chartVehicleId, bookings]);

            const addLog = async (action, details) => {
                const id = Date.now().toString();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('logs').doc(id).set({
                    id, action, details, user: currentUser?.name || 'Unknown', role: currentUser?.role || 'User', timestamp: new Date().toISOString()
                });
            };

            const handleBook = async (e) => {
                e.preventDefault();
                const id = Date.now().toString();
                const vehicle = VEHICLES.find(v => v.id === selectedVehicle.id);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').doc(id).set({
                    ...formData, id, vehicleId: selectedVehicle.id, status: 'pending', timestamp: new Date().toISOString()
                });
                await addLog('‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà', `${formData.bookerName} ‡∏à‡∏≠‡∏á‡∏£‡∏ñ ${vehicle.plate}`);
                alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                setSelectedVehicle(null);
                setActiveTab('my-status');
            };

            const updateStatus = async (bId, status, extra = {}) => {
                const b = bookings.find(x => x.id === bId);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').doc(bId).update({ status, ...extra });
                await addLog(status, `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ${b.bookerName}`);
            };

            const handleDelete = async (bId) => {
                if (currentUser.role !== 'admin') {
                    alert("‚ö†Ô∏è ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
                    return;
                }
                if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                const b = bookings.find(x => x.id === bId);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').doc(bId).delete();
                await addLog('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á ${b.bookerName}`);
            };

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-indigo-600 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>;

            if (!currentUser) {
                return (
                    <div className="h-screen flex items-center justify-center p-6 bg-slate-50">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center animate-in">
                            <h1 className="text-3xl font-black text-slate-800 mb-8">CARofGOT</h1>
                            {!showAdminLogin ? (
                                <div className="space-y-4">
                                    <button onClick={() => setCurrentUser({role:'user', name:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'})} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
                                    <button onClick={() => setShowAdminLogin(true)} className="text-slate-400 text-xs font-bold uppercase tracking-widest hover:text-indigo-600">Admin Login</button>
                                </div>
                            ) : (
                                <form onSubmit={(e)=>{e.preventDefault(); if(adminPassword==='123456') setCurrentUser({role:'admin', name:'‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'})}} className="space-y-4">
                                    <input type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" className="w-full p-4 border rounded-2xl text-center font-bold outline-none" autoFocus onChange={e=>setAdminPassword(e.target.value)} />
                                    <button className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                    <button type="button" onClick={()=>setShowAdminLogin(false)} className="text-slate-400 text-xs">‡∏Å‡∏•‡∏±‡∏ö</button>
                                </form>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-20">
                    <nav className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 px-4 md:px-6 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-xl text-white"><LucideIcon name="car" size={24}/></div>
                            <span className="font-black text-lg md:text-xl">CARofGOT</span>
                        </div>
                        <button onClick={() => setCurrentUser(null)} className="p-2.5 text-slate-300 hover:text-rose-500"><LucideIcon name="log-out" size={20}/></button>
                    </nav>

                    <div className="max-w-6xl mx-auto p-4 md:p-6">
                        <div className="flex gap-2 mb-8 bg-slate-200/50 p-1.5 rounded-2xl w-full md:w-fit overflow-x-auto tab-shadow scrollbar-hide">
                            <TabBtn active={activeTab==='schedule'} onClick={()=>setActiveTab('schedule')} label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ" icon="calendar" />
                            {currentUser.role === 'user' && <TabBtn active={activeTab==='booking'} onClick={()=>setActiveTab('booking')} label="‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà" icon="plus-circle" />}
                            <TabBtn active={activeTab==='my-status'} onClick={()=>setActiveTab('my-status')} label={currentUser.role==='admin' ? '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á' : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì'} icon="clock" />
                            {currentUser.role === 'admin' && (
                                <>
                                    <TabBtn active={activeTab==='audit'} onClick={()=>setActiveTab('audit')} label="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ" icon="check-square" />
                                    <TabBtn active={activeTab==='report'} onClick={()=>setActiveTab('report')} label="‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" icon="bar-chart-3" />
                                    <TabBtn active={activeTab==='logs'} onClick={()=>setActiveTab('logs')} label="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" icon="history" />
                                </>
                            )}
                        </div>

                        {activeTab === 'report' && (
                            <div className="space-y-8 animate-in">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <h2 className="font-black text-2xl text-slate-800">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h2>
                                    <div className="flex items-center gap-2 bg-white p-2 rounded-2xl shadow-sm border">
                                        <span className="text-[10px] font-black text-slate-400 uppercase px-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
                                        <input type="month" value={reportSelectedMonth} onChange={e=>setReportSelectedMonth(e.target.value)} className="font-bold text-sm outline-none bg-transparent" />
                                    </div>
                                </div>

                                {/* Expense Breakdown Table */}
                                <div className="bg-white rounded-[2rem] border shadow-sm overflow-hidden">
                                    <div className="p-6 border-b bg-slate-50/50 flex justify-between items-center">
                                        <h3 className="font-black text-sm uppercase tracking-widest text-slate-400">Expense Breakdown ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏±‡∏ô</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left min-w-[600px]">
                                            <thead className="bg-slate-50 text-[10px] font-black uppercase text-slate-400">
                                                <tr>
                                                    <th className="p-5">‡∏£‡∏ñ / ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                                                    <th className="p-5 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (‡∏Å‡∏°.)</th>
                                                    <th className="p-5 text-center">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô / ‡∏Ñ‡πà‡∏≤‡∏ä‡∏≤‡∏£‡πå‡∏à</th>
                                                    <th className="p-5 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y text-xs font-bold">
                                                {VEHICLES.map(v => {
                                                    const filtered = bookings.filter(b => b.vehicleId === v.id && b.status === 'completed' && b.startDate.startsWith(reportSelectedMonth));
                                                    const totalKm = filtered.reduce((s, b) => s + (Number(b.mileageEnd) - Number(b.mileageStart)), 0);
                                                    const totalFuel = filtered.reduce((s, b) => s + Number(b.fuelCost), 0);
                                                    return (
                                                        <tr key={v.id} className="hover:bg-slate-50/50">
                                                            <td className="p-5 flex items-center gap-3">
                                                                <span className="text-xl">{v.image}</span>
                                                                <div>
                                                                    <div className="text-slate-900">{v.plate}</div>
                                                                    <div className="text-[9px] text-slate-400 uppercase">{v.name}</div>
                                                                </div>
                                                            </td>
                                                            <td className="p-5 text-center text-lg">{totalKm.toLocaleString()}</td>
                                                            <td className="p-5 text-center text-lg text-emerald-600">{totalFuel.toLocaleString()} ‡∏ø</td>
                                                            <td className="p-5 text-center text-slate-400">{filtered.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Graphs Section */}
                                <div className="bg-white p-6 md:p-8 rounded-[2rem] border shadow-sm space-y-6">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-black text-sm uppercase tracking-widest text-slate-400">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (‡∏°.‡∏Ñ. - ‡∏ò.‡∏Ñ.)</h3>
                                        <select value={chartVehicleId} onChange={e=>setChartVehicleId(e.target.value)} className="p-2 border rounded-xl text-xs font-bold outline-none">
                                            {VEHICLES.map(v => <option key={v.id} value={v.id}>{v.plate} ({v.name})</option>)}
                                        </select>
                                    </div>
                                    <div className="relative h-[300px] md:h-[400px]">
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'schedule' && (
                            <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden border animate-in">
                                <div className="p-6 border-b flex justify-between items-center bg-slate-50/50">
                                    <h2 className="font-black text-lg text-slate-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                                    <div className="flex gap-2 items-center bg-white p-1 rounded-xl shadow-sm border">
                                        <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()-1))} className="p-2 hover:bg-slate-50 rounded-lg"><LucideIcon name="chevron-left" size={16}/></button>
                                        <span className="text-xs font-black px-2">{viewDate.toLocaleString('th-TH', {month:'long', year:'numeric'})}</span>
                                        <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()+1))} className="p-2 hover:bg-slate-50 rounded-lg"><LucideIcon name="chevron-right" size={16}/></button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto scrollbar-hide">
                                    <div className="timeline-track">
                                        <div className="grid grid-cols-[200px_1fr] bg-slate-100/50 border-b">
                                            <div className="p-4 text-[10px] font-black uppercase text-slate-400">‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</div>
                                            <div className="grid" style={{gridTemplateColumns: `repeat(${getDaysInMonth(viewDate)}, 1fr)`}}>
                                                {Array.from({length: getDaysInMonth(viewDate)}).map((_,i)=>(<div key={i} className="text-center py-4 text-[9px] font-bold text-slate-400 border-l border-white">{i+1}</div>))}
                                            </div>
                                        </div>
                                        {VEHICLES.map(v => (
                                            <div key={v.id} className="grid grid-cols-[200px_1fr] border-b last:border-0 h-20">
                                                <div className="p-4 bg-white border-r flex items-center gap-3">
                                                    <span className="text-2xl">{v.image}</span>
                                                    <div className="leading-none"><div className="font-bold text-sm">{v.plate}</div><div className="text-[9px] text-slate-400 font-bold uppercase">{v.name}</div></div>
                                                </div>
                                                <div className="relative grid" style={{gridTemplateColumns: `repeat(${getDaysInMonth(viewDate)}, 1fr)`}}>
                                                    {Array.from({length: getDaysInMonth(viewDate)}).map((_,i)=><div key={i} className="border-l border-slate-50 h-full"></div>)}
                                                    {bookings.filter(b=>b.vehicleId===v.id && ['approved','pending','pending_audit','completed'].includes(b.status)).map(b=>{
                                                        const start = new Date(b.startDate);
                                                        if (start.getMonth() !== viewDate.getMonth()) return null;
                                                        const sD = start.getDate(); 
                                                        const end = new Date(b.endDate);
                                                        const eD = end.getMonth() === viewDate.getMonth() ? end.getDate() : getDaysInMonth(viewDate);
                                                        const days = eD - sD + 1;
                                                        return (
                                                            <div key={b.id} className={`absolute top-2 bottom-2 rounded-lg text-white text-[9px] font-bold flex flex-col justify-center px-2 truncate shadow-md z-10 ${b.status==='pending' ? 'bg-rose-500 animate-pulse' : 'bg-indigo-500'}`}
                                                                 style={{ left: `calc(${(sD-1)*(100/getDaysInMonth(viewDate))}% + 2px)`, width: `calc(${days*(100/getDaysInMonth(viewDate))}% - 4px)` }}>
                                                                <span className="block truncate">{b.bookerName}</span>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'my-status' && (
                            <div className="space-y-4 animate-in">
                                {bookings.length === 0 ? <div className="text-center py-20 text-slate-400 font-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div> :
                                 bookings.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(b => (
                                    <div key={b.id} className="bg-white p-6 rounded-[2rem] border shadow-sm flex flex-col md:flex-row items-center gap-6 group">
                                        <div className="w-16 h-16 bg-slate-50 rounded-3xl flex items-center justify-center text-3xl shadow-inner border">{VEHICLES.find(v=>v.id===b.vehicleId)?.image}</div>
                                        <div className="flex-1 w-full text-center md:text-left">
                                            <div className="flex flex-col md:flex-row md:items-center gap-2 mb-2">
                                                <span className="font-black text-slate-800 text-lg">{b.destination}</span>
                                                <span className={`w-fit mx-auto md:mx-0 px-2.5 py-1 rounded-full text-[10px] font-black uppercase ${b.status === 'completed' ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}`}>{b.status}</span>
                                            </div>
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wide">
                                                {b.bookerName} ({b.department}) ‚Ä¢ {b.startDate} ‡∏ñ‡∏∂‡∏á {b.endDate}
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            {currentUser.role === 'admin' && b.status === 'pending' && (
                                                <button onClick={()=>updateStatus(b.id, 'approved')} className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-black text-xs">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                            )}
                                            {b.status === 'approved' && (
                                                <button onClick={()=>{setReturnModal(b); setReturnData({mileageStart:'10000', mileageEnd:'', fuelCost:'', note:''})}} className="px-6 py-2 bg-emerald-600 text-white rounded-xl font-black text-xs">‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</button>
                                            )}
                                            {/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */}
                                            {currentUser.role === 'admin' && (
                                                <button onClick={()=>handleDelete(b.id)} className="p-3 text-slate-200 hover:text-rose-500 transition-colors">
                                                    <LucideIcon name="trash-2" size={20}/>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'booking' && (
                            <div className="grid lg:grid-cols-2 gap-8 animate-in">
                                <div className="space-y-4">
                                    <h2 className="font-black text-xl text-slate-800">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        {VEHICLES.map(v => (
                                            <div key={v.id} onClick={()=>setSelectedVehicle(v)} className={`p-5 rounded-3xl border-2 transition-all cursor-pointer ${selectedVehicle?.id===v.id ? 'border-indigo-600 bg-indigo-50 shadow-lg' : 'bg-white border-transparent shadow-sm hover:border-slate-200'}`}>
                                                <div className="text-4xl mb-3">{v.image}</div>
                                                <div className="font-black text-lg">{v.plate}</div>
                                                <div className="text-[10px] text-slate-400 font-bold uppercase">{v.name}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    {selectedVehicle ? (
                                        <form onSubmit={handleBook} className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-indigo-50 space-y-5">
                                            <h3 className="font-black text-lg pb-4 border-b">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                <input type="date" required className="p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none" onChange={e=>setFormData({...formData, startDate:e.target.value})} />
                                                <input type="date" required className="p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none" onChange={e=>setFormData({...formData, endDate:e.target.value})} />
                                            </div>
                                            <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" required className="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none" onChange={e=>setFormData({...formData, bookerName:e.target.value})} />
                                            <input type="text" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å" required className="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none" onChange={e=>setFormData({...formData, department:e.target.value})} />
                                            <input type="text" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ" required className="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none" onChange={e=>setFormData({...formData, destination:e.target.value})} />
                                            <textarea placeholder="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå" required className="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none" rows="2" onChange={e=>setFormData({...formData, purpose:e.target.value})}></textarea>
                                            <button className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á</button>
                                        </form>
                                    ) : (
                                        <div className="h-full min-h-[300px] flex flex-col items-center justify-center p-10 border-4 border-dashed rounded-[3rem] text-slate-200">
                                            <LucideIcon name="mouse-pointer-2" size={48} className="mb-4 opacity-20" />
                                            <p className="font-black text-sm uppercase tracking-widest">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'audit' && (
                            <div className="space-y-4 animate-in">
                                {bookings.filter(b=>b.status==='pending_audit').map(b => (
                                    <div key={b.id} className="bg-white p-8 rounded-[2rem] shadow-sm border flex flex-col lg:flex-row gap-8">
                                        <div className="lg:w-1/3 flex items-center gap-6">
                                            <span className="text-5xl p-5 bg-slate-50 rounded-3xl border">{VEHICLES.find(v=>v.id===b.vehicleId)?.image}</span>
                                            <div>
                                                <div className="font-black text-2xl text-slate-900">{VEHICLES.find(v=>v.id===b.vehicleId)?.plate}</div>
                                                <div className="text-xs font-bold text-slate-400 uppercase">{b.bookerName}</div>
                                            </div>
                                        </div>
                                        <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <DataBox label="‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°" val={b.mileageStart} />
                                            <DataBox label="‡πÑ‡∏°‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ" val={b.mileageEnd} highlight />
                                            <DataBox label="‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°" val={`${Number(b.mileageEnd) - Number(b.mileageStart)} ‡∏Å‡∏°.`} />
                                            <DataBox label="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" val={`${b.fuelCost} ‡∏ø`} />
                                        </div>
                                        <div className="flex items-center">
                                            <button onClick={()=>updateStatus(b.id, 'completed')} className="w-full lg:w-auto px-10 py-5 bg-slate-900 text-white rounded-2xl font-black shadow-xl">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡∏Ñ‡∏∑‡∏ô</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="bg-white rounded-[2rem] border shadow-sm overflow-hidden animate-in">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left min-w-[800px]">
                                        <thead className="bg-slate-50 text-[10px] font-black uppercase text-slate-400">
                                            <tr><th className="p-5">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</th><th className="p-5">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th><th className="p-5">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th className="p-5">‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th></tr>
                                        </thead>
                                        <tbody className="divide-y text-xs font-bold">
                                            {logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 50).map(log => (
                                                <tr key={log.id} className="hover:bg-slate-50/50">
                                                    <td className="p-5 text-slate-400">{new Date(log.timestamp).toLocaleString('th-TH')}</td>
                                                    <td className="p-5"><span className="px-2 py-1 rounded bg-indigo-50 text-indigo-600 uppercase text-[10px]">{log.action}</span></td>
                                                    <td className="p-5 text-slate-700">{log.details}</td>
                                                    <td className="p-5"><div>{log.user}</div><div className="text-[10px] text-slate-400">{log.role}</div></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>

                    {returnModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-md shadow-2xl animate-in overflow-hidden">
                                <div className="bg-emerald-600 p-8 text-white">
                                    <h3 className="text-2xl font-black">‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</h3>
                                    <p className="text-emerald-100 text-xs font-bold opacity-80 uppercase tracking-widest">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</p>
                                </div>
                                <div className="p-8 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="number" required placeholder="‡πÑ‡∏°‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ" className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none" value={returnData.mileageStart} onChange={e=>setReturnData({...returnData, mileageStart:e.target.value})} />
                                        <input type="number" required placeholder="‡πÑ‡∏°‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ" className="w-full p-4 bg-slate-100 rounded-2xl font-black outline-none focus:ring-2 focus:ring-emerald-500" value={returnData.mileageEnd} autoFocus onChange={e=>setReturnData({...returnData, mileageEnd:e.target.value})} />
                                    </div>
                                    <input type="number" required placeholder="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô / ‡∏Ñ‡πà‡∏≤‡∏ä‡∏≤‡∏£‡πå‡∏à (‡∏ö‡∏≤‡∏ó)" className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none" onChange={e=>setReturnData({...returnData, fuelCost:e.target.value})} />
                                    <textarea placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" className="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none" rows="2" onChange={e=>setReturnData({...returnData, note:e.target.value})}></textarea>
                                    <div className="flex gap-3 pt-4">
                                        <button onClick={()=>setReturnModal(null)} className="flex-1 py-4 font-bold text-slate-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        <button onClick={()=>{updateStatus(returnModal.id, 'pending_audit', returnData); setReturnModal(null);}} className="flex-[2] py-4 bg-emerald-600 text-white rounded-2xl font-black">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
